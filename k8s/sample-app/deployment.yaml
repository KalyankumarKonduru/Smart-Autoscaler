apiVersion: apps/v1
kind: Deployment
metadata:
  name: sample-app
spec:
  replicas: 1
  selector:
    matchLabels: { app: sample-app }
  template:
    metadata:
      labels: { app: sample-app }
    spec:
      containers:
        - name: web
          image: node:20-alpine
          command: ["node", "/app/server.js"]
          ports: [{ containerPort: 3000 }]
          env:
            - name: PORT
              value: "3000"
          volumeMounts:
            - name: app
              mountPath: /app
      volumes:
        - name: app
          configMap:
            name: sample-app-code
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sample-app-code
data:
  server.js: |
    const express = require('express');
    const client = require('prom-client');
    const app = express();
    const register = new client.Registry();
    client.collectDefaultMetrics({ register });

    const httpRequestDurationMilliseconds = new client.Histogram({
      name: 'http_request_duration_ms',
      help: 'request duration in ms',
      labelNames: ['route'],
      buckets: [50,100,200,400,800,1600]
    });
    register.registerMetric(httpRequestDurationMilliseconds);

    app.get('/work', async (req, res) => {
      const start = Date.now();
      const delay = Math.floor(Math.random()*120)+50;
      await new Promise(r => setTimeout(r, delay));
      httpRequestDurationMilliseconds.labels('/work').observe(Date.now()-start);
      res.json({ ok: true, delay });
    });

    app.get('/metrics', async (req, res) => {
      res.set('Content-Type', register.contentType);
      res.end(await register.metrics());
    });

    const port = process.env.PORT || 3000;
    app.listen(port, () => console.log('sample-app listening on', port));
